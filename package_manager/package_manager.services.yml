services:
  # Underlying Symfony utilities.
  package_manager.symfony_file_system:
    class: Symfony\Component\Filesystem\Filesystem
  package_manager.symfony_executable_finder:
    class: Symfony\Component\Process\ExecutableFinder
  package_manager.symfony_finder:
    class: Symfony\Component\Finder\Finder

  # Basic infrastructure services.
  package_manager.process_factory:
    class: Drupal\package_manager\ProcessFactory
    arguments:
      - '@file_system'
      - '@config.factory'
  package_manager.file_system:
    class: PhpTuf\ComposerStager\Infrastructure\Filesystem\Filesystem
    arguments:
      - '@package_manager.symfony_file_system'
  package_manager.executable_finder:
    class: Drupal\package_manager\ExecutableFinder
    arguments:
      - '@package_manager.symfony_executable_finder'
      - '@config.factory'

  # Executable runners.
  package_manager.rsync_runner:
    class: PhpTuf\ComposerStager\Infrastructure\Process\Runner\RsyncRunner
    arguments:
      - '@package_manager.executable_finder'
      - '@package_manager.process_factory'
  package_manager.composer_runner:
    class: PhpTuf\ComposerStager\Infrastructure\Process\Runner\ComposerRunner
    arguments:
      - '@package_manager.executable_finder'
      - '@package_manager.process_factory'

  # File syncers.
  package_manager.file_syncer.rsync:
    class: PhpTuf\ComposerStager\Infrastructure\FileSyncer\RsyncFileSyncer
    arguments:
      - '@package_manager.file_system'
      - '@package_manager.rsync_runner'
  package_manager.file_syncer.php:
    class: PhpTuf\ComposerStager\Infrastructure\FileSyncer\PhpFileSyncer
    arguments:
      - '@package_manager.file_system'
      - '@package_manager.symfony_finder'
      - '@package_manager.symfony_finder'
  package_manager.file_syncer.factory:
    class: Drupal\package_manager\FileSyncerFactory
    arguments:
      - '@package_manager.symfony_executable_finder'
      - '@package_manager.file_syncer.php'
      - '@package_manager.file_syncer.rsync'
      - '@config.factory'
  package_manager.file_syncer:
    class: PhpTuf\ComposerStager\Infrastructure\FileSyncer\FileSyncerInterface
    factory: ['@package_manager.file_syncer.factory', 'create']

  # Domain services.
  package_manager.beginner:
    class: PhpTuf\ComposerStager\Domain\Beginner
    arguments:
      - '@package_manager.file_syncer'
      - '@package_manager.file_system'
  package_manager.stager:
    class: PhpTuf\ComposerStager\Domain\Stager
    arguments:
      - '@package_manager.composer_runner'
      - '@package_manager.file_system'
  package_manager.committer:
    class: PhpTuf\ComposerStager\Domain\Committer
    arguments:
      - '@package_manager.file_syncer'
      - '@package_manager.file_system'
  package_manager.path_locator:
    class: Drupal\package_manager\PathLocator
    arguments:
      - '@config.factory'
      - '%app.root%'

  # Validators.
  package_manager.validator.composer_executable:
    class: Drupal\package_manager\EventSubscriber\ComposerExecutableValidator
    arguments:
      - '@package_manager.composer_runner'
      - '@string_translation'
    tags:
      - { name: event_subscriber }
  package_manager.validator.disk_space:
    class: Drupal\package_manager\EventSubscriber\DiskSpaceValidator
    arguments:
      - '@package_manager.path_locator'
      - '@string_translation'
    tags:
      - { name: event_subscriber }
  package_manager.validator.pending_updates:
    class: Drupal\package_manager\EventSubscriber\PendingUpdatesValidator
    arguments:
      - '%app.root%'
      - '@update.post_update_registry'
      - '@string_translation'
    tags:
      - { name: event_subscriber }
  package_manager.validator.lock_file:
    class: Drupal\package_manager\EventSubscriber\LockFileValidator
    arguments:
      - '@state'
      - '@package_manager.path_locator'
      - '@string_translation'
    tags:
      - { name: event_subscriber }
  package_manager.validator.file_system:
    class: Drupal\package_manager\EventSubscriber\WritableFileSystemValidator
    arguments:
      - '@package_manager.path_locator'
      - '%app.root%'
      - '@string_translation'
    tags:
      - { name: event_subscriber }
  package_manager.excluded_paths_subscriber:
    class: Drupal\package_manager\EventSubscriber\ExcludedPathsSubscriber
    arguments:
      - '%app.root%'
      - '%site.path%'
      - '@file_system'
      - '@stream_wrapper_manager'
      - '@database'
    tags:
      - { name: event_subscriber }
